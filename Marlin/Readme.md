## Конфигурирование Marlin для работы с платой STM32F401CCU6_UNI

Рекомендуется использовать модицикацию последней стабильной версии оригинальной прошивки.
Готовая прошивка предлагается как пример, где можно подсмотреть настройки концевиков и прочего,
она созданна для конкретной физической машины с ее особенностями.

1.	Добавляем файл определения пинов: `..\ Marlin\src\pins\stm32f4\pins_STM32F401CCU6_UNI.h`

2.	Добавляем в файл `..\Marlin\src\pins\pins.h`:

```C
#elif MB(STM32F401CCU6)
  #include "stm32f4/pins_STM32F401CCU6_UNI.h"       // STM32F4                                env:blackpill_f401cc_uni
```

Важно: в закомментированной части строки есть информация о необходимом окружении, она парсится скриптом во время подготовки 
к компиляции, поэтому должна соответствовать имени вашего окружения на шаге 5.

3.	Добавляем в файл `..\Marlin\src\core\boards.h`:

```C
#define BOARD_STM32F401CCU6_UNI           4301  // STM32F401CCU6 BLACKPILL BOARD
```

Номер после названия платы может быть любым (при выходе свежих версий система нумерации периодически изменяется, а уже 
существующие номера сдвигаются), главное чтобы он был уникальным.

4.	В файлe `..\Marlin\Configuration.h` производим необходимые изменения и указываем нашу плату:

```C
#ifndef MOTHERBOARD
  #define MOTHERBOARD BOARD_STM32F401CCU6_UNI
#endif
```

5.	В файл `..\ini\stm32f4.ini` добавляем определение окружения:

```C
#
# blackpill_f401cc
#
[env:blackpill_f401cc_uni]
platform             = ststm32
extends              = common_stm32
board                 = blackpill_f401cc
board_build.offset   = 0x0000
build_flags          = ${common_stm32.build_flags}
                                -Os -DHAL_PCD_MODULE_ENABLED
                                -DHAL_UART_MODULE_ENABLED
monitor_speed        = 250000
upload_protocol      = dfu
```

6.	Прошиваем выбрав окружение `env:blackpill_f401cc_uni`.

После прошивки не забываем сбросить настройки EEPROM командой `M502` и сохранить их вновь командой `M500`.

## Добавление своих терморезисторов в Marlin.

1.	Создаем header-файл с калибровкой терморезистора и именем `.. \Marlin\src\module\thermistor\thermistor_59.h`:

```C
#pragma once

constexpr temp_entry_t temptable_59[] PROGMEM = {
  { OV(91),   300 },
  { OV(106),  290 },
  { OV(121),  280 },
  { OV(140),  270 },
  { OV(161),  260 },
  { OV(186),  250 },
  { OV(217),  240 },
  { OV(248),  230 },
  { OV(287),  220 },
  { OV(330),  210 },
  { OV(374),  200 },
  { OV(426),  190 },
  { OV(478),  180 },
  { OV(536),  170 },
  { OV(594),  160 },
  { OV(654),  150 },
  { OV(709),  140 },
  { OV(760),  130 },
  { OV(807),  120 },
  { OV(850),  110 },
  { OV(887),  100 },
  { OV(919),   90 },
  { OV(944),   80 },
  { OV(964),   70 },
  { OV(980),   60 },
  { OV(993),   50 },
  { OV(1001),  40 },
  { OV(1006),  30 },
  { OV(1007),  25 },
  { OV(1017),  0 }
};
```

2.	В файл записываем свою таблицу калибровки, показания АЦП (чтобы их видеть в консоли, необходимо раскомментировать параметр `#define SHOW_TEMP_ADC_VALUES` в файле `..\Marlin\Configuration_adv.h`) и показания реальной температуры, полученной с помощью своей термопары или иным заведомо точным способом. Значения АЦП записываются в 10-битном виде, поэтому если у вас АЦП имеет 12 бит, то значения стоит делить на 4 (2 в степени битность вашего АЦП минус 10). Чем чаще шаг по температуре, тем лучше, но чаще 10 смысла делать нет, верхний предел записываем тот, который нам необходим (очевидно, нет смысла калибровать стол до 270 градусов).

3.	В файл `..\Marlin\src\module\thermistor\thermistors.h` добавляем строки:

```C
#if ANY_THERMISTOR_IS(59)
  #include "thermistor_59.h"
#endif
```

4.	В файле `..\Marlin\Configuration.h` определяем как используемый наш резистор:

```C
#define TEMP_SENSOR_0 59
```C
